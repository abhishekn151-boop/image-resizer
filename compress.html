<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>Image Compressor — Free Image Resizer</title>

  <link rel="icon" type="image/png" href="assets/favicon.png" />
  <link rel="stylesheet" href="style.css" />

  <style>
    /* Make inputs look uniform */
    .settings input, .settings select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #2b3b5a;
      background: #0f1829;
      color: #e8ecf4;
      font-size: 14px;
    }

    .settings h3 { margin-top: 20px; }
  </style>
</head>

<body>

<nav class="top-nav">
  <div class="nav-left">
    <img src="assets/logo.png" class="nav-logo" alt="Free Image Resizer logo">
    <span class="nav-title">Free Image Resizer</span>
  </div>

  <div class="hamburger" id="hamburger">☰</div>

  <div class="nav-links" id="mobileMenu">

    <!-- TOOLS DROPDOWN MENU -->
    <div class="dropdown">
      <button class="dropbtn">Tools ▼</button>
      <div class="dropdown-content">
        <a href="index.html">Image Resizer</a>
        <a href="compress.html">Image Compressor</a>
      </div>
    </div>

    <a href="about.html">About Us</a>
    <a href="faq.html">FAQ</a>
    <a href="privacy.html">Privacy Policy</a>
    <a href="terms.html">Terms of Service</a>
    <a href="contact.html">Contact</a>
  </div>
</nav>

<header class="head">
  <h1>Image Compressor</h1>
  <p class="tagline">Compress images to an exact file size.</p>
</header>

<!-- TOOL -->
<div class="tool-container">

  <!-- UPLOAD -->
  <div id="drop-area" class="drop-area" role="button">
    <h2>Upload Image</h2>
    <p>Drop or Click</p>
    <input type="file" id="fileInput" accept="image/*" hidden />
  </div>

  <!-- SETTINGS (only TWO options) -->
  <div class="settings">
    <h3>Target File Size (KB)</h3>
    <input id="targetSizeKB" type="number" min="1" placeholder="e.g. 200" />

    <h3>Format</h3>
    <select id="formatSelect">
      <option value="image/jpeg">JPEG</option>
      <option value="image/webp">WebP</option>
    </select>
  </div>

  <!-- PREVIEW -->
  <div class="preview-section">
    <h3>Preview</h3>
    <img id="previewImg" class="preview-img" alt="Preview appears here" />
    <p id="previewInfo"></p>
  </div>

</div>

<div class="actions">
  <button id="processBtn" class="btn">Compress</button>
  <button id="downloadBtn" class="btn disabled" disabled>Download</button>
</div>

<!-- LOADING OVERLAY -->
<div id="loadingOverlay" class="loading-overlay hidden">
  <div class="spinner"></div>
  <p>Processing...</p>
</div>

<!-- FOOTER -->
<footer>
  <p>
    © <span id="year"></span> Free Image Resizer |
    <a href="index.html">Home</a> |
    <a href="compress.html">Compressor</a> |
    <a href="about.html">About Us</a> |
    <a href="faq.html">FAQ</a> |
    <a href="privacy.html">Privacy Policy</a> |
    <a href="terms.html">Terms</a> |
    <a href="contact.html">Contact</a>
  </p>
</footer>

<script>
  document.getElementById("year").textContent = new Date().getFullYear();
  document.getElementById("hamburger").onclick = () =>
    document.getElementById("mobileMenu").classList.toggle("active");
</script>

<!-- MAIN SCRIPT -->
<script type="module">
  import {
    loadImage,
    getExifOrientation,
    applyOrientation,
    safeURL,
    formatDim,
    formatSize,
    canvasToBlob,
    compressCanvasToTarget
  } from "./utils.js";

  const fileInput = document.getElementById("fileInput");
  const dropArea = document.getElementById("drop-area");
  const previewImg = document.getElementById("previewImg");
  const previewInfo = document.getElementById("previewInfo");

  const targetSizeKB = document.getElementById("targetSizeKB");
  const formatSelect = document.getElementById("formatSelect");

  const processBtn = document.getElementById("processBtn");
  const downloadBtn = document.getElementById("downloadBtn");
  const loading = document.getElementById("loadingOverlay");

  let currentFile = null;
  let currentImage = null;
  let currentOrientation = 1;

  function setStatus(msg) {
    previewInfo.textContent = msg;
  }

  function showLoader() { loading.classList.remove("hidden"); }
  function hideLoader() { loading.classList.add("hidden"); }

  function enableDownload(v) {
    downloadBtn.disabled = !v;
    downloadBtn.classList.toggle("disabled", !v);
  }

  function prevent(e){ e.preventDefault(); e.stopPropagation(); }

  ["dragenter","dragover","dragleave","drop"].forEach(ev =>
    dropArea.addEventListener(ev, prevent)
  );

  dropArea.addEventListener("drop", e => {
    handleFiles(e.dataTransfer.files);
  });

  dropArea.addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", () => handleFiles(fileInput.files));

  async function handleFiles(files) {
    const file = files[0];
    if (!file || !file.type.startsWith("image/")) return alert("Upload an image");

    currentFile = file;
    currentOrientation = await getExifOrientation(file).catch(() => 1);

    currentImage = await loadImage(file);
    previewImg.src = safeURL(file);
    previewImg.style.display = "block";

    setStatus(
      formatSize(file.size) +
      " • " +
      currentImage.naturalWidth + "×" + currentImage.naturalHeight
    );

    enableDownload(false);
  }

  async function compressImage() {
    if (!currentImage) return alert("Upload an image first!");

    const kb = Number(targetSizeKB.value);
    if (!kb || kb <= 0) return alert("Enter target size (KB)");

    showLoader();
    processBtn.disabled = true;
    setStatus("Compressing...");

    try {
      const W = currentImage.naturalWidth;
      const H = currentImage.naturalHeight;

      const temp = document.createElement("canvas");
      temp.width = W;
      temp.height = H;
      const tctx = temp.getContext("2d");

      const rawCanvas = document.createElement("canvas");
      rawCanvas.width = W;
      rawCanvas.height = H;
      rawCanvas.getContext("2d").drawImage(currentImage, 0, 0);

      const oriented =
        currentOrientation !== 1 ? applyOrientation(rawCanvas, currentOrientation) : rawCanvas;

      tctx.drawImage(oriented, 0, 0);

      const result = await compressCanvasToTarget(temp, {
        mime: formatSelect.value,
        targetBytes: kb * 1024
      });

      const url = safeURL(result.blob);
      previewImg.src = url;

      setStatus(formatSize(result.achievedBytes) + " • " + formatDim(result.width, result.height));

      downloadBtn.onclick = () => {
        const a = document.createElement("a");
        const ext = formatSelect.value.split("/")[1];
        a.href = url;
        a.download = "compressed." + ext;
        a.click();
      };

      enableDownload(true);

    } catch (e) {
      alert("Compression failed");
      console.error(e);
    }

    hideLoader();
    processBtn.disabled = false;
  }

  processBtn.addEventListener("click", compressImage);
</script>

</body>
</html>
