<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>Image Compressor — Free Tools Hub</title>
  <base href="/image-resizer/">

  <!-- FIXED favicon path -->
  <link rel="icon" type="image/png" href="/assets/favicon.png" />

  <!-- FIXED stylesheet path -->
  <link rel="stylesheet" href="/style.css" />

  <style>
    .settings input, .settings select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #2b3b5a;
      background: #0f1829;
      color: #e8ecf4;
      font-size: 14px;
    }

    .settings h3 { margin-top: 20px; }
  </style>
</head>

<body>

<!-- TOP NAVIGATION BAR -->
<div id="navbar"></div>
<script>
  fetch("/components/navbar.html") <!-- FIXED PATH -->
    .then(r => r.text())
    .then(html => {
      document.getElementById("navbar").innerHTML = html;

      const ham = document.getElementById("hamburger");
      const menu = document.getElementById("mobileMenu");

      if (ham && menu) {
        ham.onclick = () => menu.classList.toggle("active");
      }
    });
</script>

<header class="head">
  <h1>Image Compressor</h1>
  <p class="tagline">Compress images to an exact file size.</p>
</header>

<!-- TOOL -->
<div class="tool-container">

  <!-- UPLOAD -->
  <div id="drop-area" class="drop-area" role="button">
    <h2>Upload Image</h2>
    <p>Drop or Click</p>
    <input type="file" id="fileInput" accept="image/*" hidden />
  </div>

  <!-- SETTINGS -->
  <div class="settings">
    <h3>Target File Size (KB)</h3>
    <input id="targetSizeKB" type="number" min="1" placeholder="e.g. 200" />

    <h3>Format</h3>
    <select id="formatSelect">
      <option value="image/jpeg">JPEG</option>
      <option value="image/webp">WebP</option>
    </select>
  </div>

  <!-- PREVIEW -->
  <div class="preview-section">
    <h3>Preview</h3>
    <img id="previewImg" class="preview-img" alt="Preview appears here" />
    <p id="previewInfo"></p>
  </div>

</div>

<div class="actions">
  <button id="processBtn" class="btn">Compress</button>
  <button id="downloadBtn" class="btn disabled" disabled>Download</button>
</div>

<div id="loadingOverlay" class="loading-overlay hidden">
  <div class="spinner"></div>
  <p>Processing...</p>
</div>

<!-- FOOTER -->
<footer class="vertical-footer">
  <ul>
    <li><a href="/about.html">About Us</a></li>
    <li><a href="/privacy.html">Privacy Policy</a></li>
    <li><a href="/terms.html">Terms of Service</a></li>
    <li><a href="/contact.html">Contact</a></li>
    <li><a href="/faq.html">FAQ</a></li>
  </ul>
  <p>© <span id="year"></span> Free Tools Hub — All Rights Reserved.</p>
</footer>

<!-- MAIN SCRIPT -->
<script type="module">
  import {
    loadImage,
    getExifOrientation,
    applyOrientation,
    safeURL,
    formatDim,
    formatSize,
    canvasToBlob,
    compressCanvasToTarget
  } from "/utils.js";   <!-- FIXED PATH -->

  const fileInput = document.getElementById("fileInput");
  const dropArea = document.getElementById("drop-area");
  const previewImg = document.getElementById("previewImg");
  const previewInfo = document.getElementById("previewInfo");

  const targetSizeKB = document.getElementById("targetSizeKB");
  const formatSelect = document.getElementById("formatSelect");

  const processBtn = document.getElementById("processBtn");
  const downloadBtn = document.getElementById("downloadBtn");
  const loading = document.getElementById("loadingOverlay");

  let currentFile = null;
  let currentImage = null;
  let currentOrientation = 1;

  function setStatus(msg) { previewInfo.textContent = msg; }
  function showLoader() { loading.classList.remove("hidden"); }
  function hideLoader() { loading.classList.add("hidden"); }
  function enableDownload(v) {
    downloadBtn.disabled = !v;
    downloadBtn.classList.toggle("disabled", !v);
  }

  function prevent(e){ e.preventDefault(); e.stopPropagation(); }
  ["dragenter","dragover","dragleave","drop"].forEach(ev =>
    dropArea.addEventListener(ev, prevent)
  );

  dropArea.addEventListener("drop", e => handleFiles(e.dataTransfer.files));
  dropArea.addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", () => handleFiles(fileInput.files));

  async function handleFiles(files) {
    const file = files[0];
    if (!file || !file.type.startsWith("image/")) return alert("Upload an image");

    currentFile = file;
    currentOrientation = await getExifOrientation(file).catch(() => 1);

    currentImage = await loadImage(file);
    previewImg.src = safeURL(file);
    previewImg.style.display = "block";

    setStatus(
      formatSize(file.size) +
      " • " +
      currentImage.naturalWidth + "×" + currentImage.naturalHeight
    );

    enableDownload(false);
  }

  async function compressImage() {
    if (!currentImage) return alert("Upload an image first!");

    const kb = Number(targetSizeKB.value);
    if (!kb || kb <= 0) return alert("Enter target size (KB)");

    showLoader();
    processBtn.disabled = true;
    setStatus("Compressing...");

    try {
      const W = currentImage.naturalWidth;
      const H = currentImage.naturalHeight;

      const temp = document.createElement("canvas");
      temp.width = W;
      temp.height = H;
      const tctx = temp.getContext("2d");

      const rawCanvas = document.createElement("canvas");
      rawCanvas.width = W;
      rawCanvas.height = H;
      rawCanvas.getContext("2d").drawImage(currentImage, 0, 0);

      const oriented =
        currentOrientation !== 1 ? applyOrientation(rawCanvas, currentOrientation) : rawCanvas;

      tctx.drawImage(oriented, 0, 0);

      const result = await compressCanvasToTarget(temp, {
        mime: formatSelect.value,
        targetBytes: kb * 1024
      });

      const url = safeURL(result.blob);
      previewImg.src = url;

      setStatus(formatSize(result.achievedBytes) + " • " + formatDim(result.width, result.height));

      downloadBtn.onclick = () => {
        const a = document.createElement("a");
        const ext = formatSelect.value.split("/")[1];
        a.href = url;
        a.download = "compressed." + ext;
        a.click();
      };

      enableDownload(true);

    } catch (e) {
      alert("Compression failed");
      console.error(e);
    }

    hideLoader();
    processBtn.disabled = false;
  }

  processBtn.addEventListener("click", compressImage);
</script>

<script>
  document.getElementById("year").textContent = new Date().getFullYear();
</script>

</body>
</html>
