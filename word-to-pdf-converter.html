<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Word → PDF — Auto A4 Pagination</title>

<link rel="icon" type="image/png" href="assets/favicon.png" />
<meta name="description" content="DOCX → PDF with automatic A4 pagination (no heading detection required)." />

<!-- Local libraries -->
<script src="libs/jszip.min.js"></script>
<script src="libs/mammoth.browser.min.js"></script>
<script src="libs/html2pdf.bundle.min.js"></script>

<style>
  body { background:#071024; color:#e8eef8; font-family: Inter, system-ui, sans-serif; margin:0; padding:24px; }
  .wrap { max-width:1150px; margin:0 auto; }
  h1 { color:#fff; text-align:center; margin:8px 0 6px; }
  .convert-container {
    display:grid;
    grid-template-columns:360px 1fr;
    gap:20px;
    align-items:stretch;
    margin-top:18px;
  }
  @media (max-width:900px){ .convert-container{ grid-template-columns:1fr; } }

  .panel {
    background:#0e1a2a;
    border:1px solid #1f2f44;
    border-radius:10px;
    padding:16px;
    box-sizing:border-box;
    height:100%;
    display:flex;
    flex-direction:column;
  }

  .drop {
    background:#0b1420;
    border:2px dashed #21334a;
    border-radius:8px;
    padding:18px;
    text-align:center;
    cursor:pointer;
    color:#9ec6ff;
  }

  .small-input { width:100%; padding:10px; border-radius:8px; border:1px solid #23364f; background:#081220; color:#dfefff; margin-top:10px; }
  .btn { width:100%; padding:10px; border-radius:8px; border:none; background:#1f9bff; color:white; font-size:15px; cursor:pointer; margin-top:12px; }
  .btn.secondary { background:#55616f; }
  .muted { color:#9fb1d6; font-size:14px; margin-top:10px; }

  .preview-panel {
    background:#071424;
    border:1px solid #1b2b3f;
    border-radius:10px;
    padding:16px;
    min-height:360px;
    box-sizing:border-box;
  }

  .doc-preview {
    background:white;
    color:#111;
    padding:20px;
    border-radius:6px;
    border:1px solid #d8dce6;
    box-sizing:border-box;
    font-family:"Times New Roman", Georgia, serif;
    line-height:1.45;
    max-width:100%;
    overflow:auto;
  }

  .offscreen {
    position: fixed;
    top: 0;
    left: -200vw;   /* move offscreen but keep full size */
    opacity: 0;
    pointer-events: none;
    z-index: -1;
}

  .pdf-page {
    width:210mm;
    height:297mm;
    background:white;
    overflow:hidden;
    margin-bottom:8px;
    box-sizing:border-box;
  }

  .doc-preview-responsive { max-width:100%; }
  /* Remove absolute positioning from mammoth output */
  #previewWrapper *[style*="position:absolute"] {
    position: static !important;
    left: auto !important;
    top: auto !important;
    transform: none !important;
  }
</style>
</head>
<body>

<!-- NAVBAR -->
<div id="navbar"></div>
<script>
fetch("components/navbar.html")
  .then(r => r.text())
  .then(html => {
    document.getElementById("navbar").innerHTML = html;
    const ham = document.getElementById("hamburger");
    const menu = document.getElementById("mobileMenu");
    if (ham && menu) ham.onclick = () => menu.classList.toggle("active");
  });
</script>

<!-- OPEN WRAPPER (Correct Location) -->
<div class="wrap">

<h1>Word → PDF Converter (Auto A4 Pagination)</h1>
<div class="convert-container">

  <div class="panel">
    <h3 style="color:#7fc6ff;margin:0 0 10px;">Upload DOCX</h3>

    <div id="dropArea" class="drop" role="button">
      <div style="font-weight:600;">Drop .docx here</div>
      <div class="muted">or click to browse</div>
      <input id="fileInput" type="file" accept=".docx" hidden>
    </div>

    <label class="muted">Output filename</label>
    <input id="outName" class="small-input" value="document.pdf">

    <label class="muted">PDF quality (scale)</label>
    <input id="pdfScale" class="small-input" type="number" value="1" min="0.5" max="2" step="0.1">

    <button id="convertBtn" class="btn" disabled>Convert to PDF</button>
    <button id="resetBtn" class="btn secondary">Reset</button>

    <div id="status" class="muted">No document loaded.</div>
  </div>

  <div class="preview-panel panel">
    <div id="previewWrapper" class="doc-preview doc-preview-responsive">
      <div id="noPreview" class="muted">No document loaded. Preview appears here.</div>
    </div>
  </div>

</div> <!-- end convert-container -->
</div> <!-- CLOSE WRAP -->

  <!-- Offscreen containers MUST be outside wrapper -->
<div id="paginatorOffscreen" class="offscreen" aria-hidden="true"></div>
<div id="pdfPagesContainer" class="offscreen" aria-hidden="true"></div>
  
<script>
/* ---------- Utilities ---------- */
const mmToPx = (mm) => (mm / 25.4) * 96;
const A4 = { w_mm: 210, h_mm: 297 };
const pageCssWidthPx = Math.round(mmToPx(A4.w_mm));
const pageCssHeightPx = Math.round(mmToPx(A4.h_mm));

/* ---------- Elements ---------- */
const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');
const previewWrapper = document.getElementById('previewWrapper');
const noPreview = document.getElementById('noPreview');
const convertBtn = document.getElementById('convertBtn');
const resetBtn = document.getElementById('resetBtn');
const outName = document.getElementById('outName');
const pdfScaleEl = document.getElementById('pdfScale');
const status = document.getElementById('status');

const paginatorOffscreen = document.getElementById('paginatorOffscreen');
const pdfPagesContainer = document.getElementById('pdfPagesContainer');

let currentDocHtml = "";
let currentFileName = "";

/* drag drop */
dropArea.onclick = () => fileInput.click();
dropArea.addEventListener("dragover", e => { e.preventDefault(); });
dropArea.addEventListener("drop", e => {
  e.preventDefault();
  if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', () => {
  if (fileInput.files[0]) handleFile(fileInput.files[0]);
  fileInput.value = '';
});

/* DOCX -> HTML */
async function handleFile(file) {
  currentFileName = file.name;
  status.textContent = 'Parsing DOCX...';
  convertBtn.disabled = true;
  previewWrapper.innerHTML = '';

  try {
    const ab = await file.arrayBuffer();
    const result = await mammoth.convertToHtml({ arrayBuffer: ab });
    currentDocHtml = result.value || '';
    previewWrapper.innerHTML = currentDocHtml;
    noPreview.style.display = 'none';
    status.textContent = 'Document loaded.';
    convertBtn.disabled = false;
  } catch (err) {
    alert('Failed to parse DOCX.');
  }
}

/* ---------- helper: wait for imgs inside an element ---------- */
function waitForImages(root, timeout = 5000) {
  const imgs = Array.from(root.querySelectorAll('img'));
  if (!imgs.length) return Promise.resolve();
  let loaded = 0;
  return new Promise((resolve) => {
    const done = () => {
      loaded++;
      if (loaded >= imgs.length) resolve();
    };
    let timer = setTimeout(() => {
      // give up after timeout but resolve anyway so we don't hang forever
      resolve();
    }, timeout);
    imgs.forEach(img => {
      if (img.complete && img.naturalWidth !== 0) done();
      else {
        img.addEventListener('load', () => { done(); }, { once: true });
        img.addEventListener('error', () => { done(); }, { once: true });
      }
    });
  });
}

/* ---------- Pagination builder (robust) ---------- */
async function buildPagedDocument(html, scale = 1) {
  // clear previous
  paginatorOffscreen.innerHTML = '';
  pdfPagesContainer.innerHTML = '';

  // Create render area with exact CSS width for A4
  const render = document.createElement('div');
  render.style.width = pageCssWidthPx + 'px';
  render.style.boxSizing = 'border-box';
  render.style.padding = '20px';
  render.style.fontFamily = '"Times New Roman", Georgia, serif';
  render.style.lineHeight = '1.45';
  render.innerHTML = html;

  // Put render into offscreen so browser computes layout.
  // Keep it in DOM and renderable (not display:none). We'll position it off-screen but visible.
  paginatorOffscreen.appendChild(render);

  // Wait for images inside render to load (so height calculations are correct)
  await waitForImages(render, 4000);

  // Give browser a tick to compute layout
  await new Promise(r => requestAnimationFrame(r));

  const totalHeight = render.scrollHeight;
  const pageHeight = pageCssHeightPx;
  const pages = Math.max(1, Math.ceil(totalHeight / pageHeight));

  // Build pages
  for (let i = 0; i < pages; i++) {
    const pageWrap = document.createElement('div');
    pageWrap.className = 'pdf-page';
    pageWrap.style.width = pageCssWidthPx + 'px';
    pageWrap.style.height = pageCssHeightPx + 'px';
    pageWrap.style.boxSizing = 'border-box';
    pageWrap.style.position = 'relative';
    pageWrap.style.overflow = 'hidden';
    pageWrap.style.background = 'white';

    // clone the full render and shift it up so the slice for this page is visible
    const clone = render.cloneNode(true);

    // Ensure clone has layout width and is absolutely positioned inside pageWrap
    clone.style.position = 'absolute';
    clone.style.left = '0';
    clone.style.top = '0';
    clone.style.width = pageCssWidthPx + 'px';
    clone.style.boxSizing = 'border-box';
    clone.style.transform = `translateY(-${i * pageHeight}px)`;
    clone.style.webkitTransform = clone.style.transform;

    pageWrap.appendChild(clone);
    pdfPagesContainer.appendChild(pageWrap);
  }

  return { pages, container: pdfPagesContainer };
}

/* ---------- Convert to PDF (robust wrapper append) ---------- */
convertBtn.addEventListener('click', async () => {
  if (!currentDocHtml) { alert('No document loaded.'); return; }

  convertBtn.disabled = true;
  status.textContent = 'Preparing pages...';

  try {
    const scale = Number(pdfScaleEl.value) || 1;

    // Build pages (this waits for images)
    const { pages, container } = await buildPagedDocument(currentDocHtml, scale);
    console.log('Pages built:', pages, 'container children:', container.children.length);

    status.textContent = `Rendering ${pages} page(s)...`;

    // Create a visible-but-invisible wrapper and append the container into it.
    // Important: wrapper must be in the viewport and not display:none — html2canvas needs layout.
    const wrapper = document.createElement('div');
    wrapper.style.position = 'fixed';
    wrapper.style.left = '0';
    wrapper.style.top = '0';
    wrapper.style.width = pageCssWidthPx + 'px';
    // set height to contain all pages (helps html2canvas compute)
    wrapper.style.height = (pageCssHeightPx * pages) + 'px';
    wrapper.style.overflow = 'hidden';
    wrapper.style.opacity = '0';           // invisible to user
    wrapper.style.pointerEvents = 'none';
    wrapper.style.zIndex = '999999';
    wrapper.appendChild(container);

    document.body.appendChild(wrapper);

    // Small tick to ensure render
    await new Promise(r => requestAnimationFrame(r));

    const opt = {
      margin: 10,
      filename: (outName.value && outName.value.trim()) ? outName.value.trim() : 'document.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: scale, useCORS: true, allowTaint: false, logging: false },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
      pagebreak: { mode: ['css', 'legacy'] }
    };

    // Trigger html2pdf
    await html2pdf().set(opt).from(container).save();

    // cleanup
    document.body.removeChild(wrapper);
    pdfPagesContainer.innerHTML = '';
    paginatorOffscreen.innerHTML = '';

    status.textContent = 'PDF created and downloaded.';
  } catch (err) {
    console.error('PDF generation error:', err);
    alert('PDF generation failed — check console.');
    status.textContent = 'PDF failed.';
  } finally {
    convertBtn.disabled = false;
  }
});
  
/* reset */
resetBtn.addEventListener('click', () => location.reload());
</script>

</body>
</html>
