<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Word → PDF — Auto A4 Pagination</title>

<link rel="icon" type="image/png" href="assets/favicon.png" />
<meta name="description" content="DOCX → PDF with automatic A4 pagination (no heading detection required)." />

<!-- Local libraries -->
<script src="libs/jszip.min.js"></script>
<script src="libs/mammoth.browser.min.js"></script>
<script src="libs/html2pdf.bundle.min.js"></script>

<style>
  body { background:#071024; color:#e8eef8; font-family: Inter, system-ui, sans-serif; margin:0; padding:24px; }
  .wrap { max-width:1150px; margin:0 auto; }
  h1 { color:#fff; text-align:center; margin:8px 0 6px; }
  .convert-container {
    display:grid;
    grid-template-columns:360px 1fr;
    gap:20px;
    align-items:stretch;
    margin-top:18px;
  }
  @media (max-width:900px){ .convert-container{ grid-template-columns:1fr; } }

  .panel {
    background:#0e1a2a;
    border:1px solid #1f2f44;
    border-radius:10px;
    padding:16px;
    box-sizing:border-box;
    height:100%;
    display:flex;
    flex-direction:column;
  }

  .drop {
    background:#0b1420;
    border:2px dashed #21334a;
    border-radius:8px;
    padding:18px;
    text-align:center;
    cursor:pointer;
    color:#9ec6ff;
  }

  .small-input { width:100%; padding:10px; border-radius:8px; border:1px solid #23364f; background:#081220; color:#dfefff; margin-top:10px; }
  .btn { width:100%; padding:10px; border-radius:8px; border:none; background:#1f9bff; color:white; font-size:15px; cursor:pointer; margin-top:12px; }
  .btn.secondary { background:#55616f; }
  .muted { color:#9fb1d6; font-size:14px; margin-top:10px; }

  .preview-panel {
    background:#071424;
    border:1px solid #1b2b3f;
    border-radius:10px;
    padding:16px;
    min-height:360px;
    box-sizing:border-box;
  }

  .doc-preview {
    background:white;
    color:#111;
    padding:20px;
    border-radius:6px;
    border:1px solid #d8dce6;
    box-sizing:border-box;
    font-family:"Times New Roman", Georgia, serif;
    line-height:1.45;
    max-width:100%;
    overflow:auto;
  }

  .offscreen { position:absolute; left:-99999px; top:0; width:0; height:0; overflow:hidden; visibility:hidden; }

  .pdf-page {
    width:210mm;
    height:297mm;
    background:white;
    overflow:hidden;
    margin-bottom:8px;
    box-sizing:border-box;
  }

  .doc-preview-responsive { max-width:100%; }
</style>
</head>
<body>

<!-- NAVBAR -->
<div id="navbar"></div>
<script>
fetch("components/navbar.html")
  .then(r => r.text())
  .then(html => {
    document.getElementById("navbar").innerHTML = html;
    const ham = document.getElementById("hamburger");
    const menu = document.getElementById("mobileMenu");
    if (ham && menu) ham.onclick = () => menu.classList.toggle("active");
  });
</script>

<!-- OPEN WRAPPER (Correct Location) -->
<div class="wrap">

<h1>Word → PDF Converter (Auto A4 Pagination)</h1>
<div class="convert-container">

  <div class="panel">
    <h3 style="color:#7fc6ff;margin:0 0 10px;">Upload DOCX</h3>

    <div id="dropArea" class="drop" role="button">
      <div style="font-weight:600;">Drop .docx here</div>
      <div class="muted">or click to browse</div>
      <input id="fileInput" type="file" accept=".docx" hidden>
    </div>

    <label class="muted">Output filename</label>
    <input id="outName" class="small-input" value="document.pdf">

    <label class="muted">PDF quality (scale)</label>
    <input id="pdfScale" class="small-input" type="number" value="1" min="0.5" max="2" step="0.1">

    <button id="convertBtn" class="btn" disabled>Convert to PDF</button>
    <button id="resetBtn" class="btn secondary">Reset</button>

    <div id="status" class="muted">No document loaded.</div>
  </div>

  <div class="preview-panel panel">
    <div id="previewWrapper" class="doc-preview doc-preview-responsive">
      <div id="noPreview" class="muted">No document loaded. Preview appears here.</div>
    </div>
  </div>

</div> <!-- end convert-container -->

<!-- FIXED: Offscreen containers MUST be inside .wrap -->
<div id="paginatorOffscreen" class="offscreen" aria-hidden="true"></div>
<div id="pdfPagesContainer" class="offscreen" aria-hidden="true"></div>

</div> <!-- CLOSE WRAP -->
<script>
/* ---------- Utilities ---------- */
const mmToPx = (mm) => (mm / 25.4) * 96;
const A4 = { w_mm: 210, h_mm: 297 };
const pageCssWidthPx = Math.round(mmToPx(A4.w_mm));
const pageCssHeightPx = Math.round(mmToPx(A4.h_mm));

/* ---------- Elements ---------- */
const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');
const previewWrapper = document.getElementById('previewWrapper');
const noPreview = document.getElementById('noPreview');
const convertBtn = document.getElementById('convertBtn');
const resetBtn = document.getElementById('resetBtn');
const outName = document.getElementById('outName');
const pdfScaleEl = document.getElementById('pdfScale');
const status = document.getElementById('status');

const paginatorOffscreen = document.getElementById('paginatorOffscreen');
const pdfPagesContainer = document.getElementById('pdfPagesContainer');

let currentDocHtml = "";
let currentFileName = "";

/* drag drop */
dropArea.onclick = () => fileInput.click();
dropArea.addEventListener("dragover", e => { e.preventDefault(); });
dropArea.addEventListener("drop", e => {
  e.preventDefault();
  if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', () => {
  if (fileInput.files[0]) handleFile(fileInput.files[0]);
  fileInput.value = '';
});

/* DOCX -> HTML */
async function handleFile(file) {
  currentFileName = file.name;
  status.textContent = 'Parsing DOCX...';
  convertBtn.disabled = true;
  previewWrapper.innerHTML = '';

  try {
    const ab = await file.arrayBuffer();
    const result = await mammoth.convertToHtml({ arrayBuffer: ab });
    currentDocHtml = result.value || '';
    previewWrapper.innerHTML = currentDocHtml;
    noPreview.style.display = 'none';
    status.textContent = 'Document loaded.';
    convertBtn.disabled = false;
  } catch (err) {
    alert('Failed to parse DOCX.');
  }
}

/* pagination builder */
function buildPagedDocument(html, scale = 1) {
  paginatorOffscreen.innerHTML = '';
  pdfPagesContainer.innerHTML = '';

  const render = document.createElement('div');
  render.style.width = pageCssWidthPx + 'px';
  render.style.padding = '20px';
  render.style.fontFamily = '"Times New Roman", Georgia, serif';
  render.style.lineHeight = '1.45';
  render.innerHTML = html;

  paginatorOffscreen.appendChild(render);

  render.querySelectorAll('img').forEach(img => {
    img.style.maxWidth = '100%';
    img.style.height = 'auto';
  });

  return new Promise(resolve => {
    setTimeout(() => {
      const totalHeight = render.scrollHeight;
      const pageHeight = pageCssHeightPx;
      const pages = Math.ceil(totalHeight / pageHeight);

      for (let i = 0; i < pages; i++) {
        const page = document.createElement('div');
        page.className = 'pdf-page';

        const clone = render.cloneNode(true);
        clone.style.position = 'absolute';
        clone.style.transform = `translateY(-${i * pageHeight}px)`;

        page.appendChild(clone);
        pdfPagesContainer.appendChild(page);
      }

      resolve({ pages, container: pdfPagesContainer });
    }, 350);
  });
}

/* convert */
convertBtn.addEventListener('click', async () => {
  status.textContent = 'Preparing pages...';

  const scale = Number(pdfScaleEl.value) || 1;
  const { container } = await buildPagedDocument(currentDocHtml, scale);

  const opt = {
    margin: 10,
    filename: outName.value.trim() || 'document.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale, useCORS: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };

  await html2pdf().set(opt).from(container).save();
  status.textContent = 'PDF created.';
});

/* reset */
resetBtn.addEventListener('click', () => location.reload());
</script>

</body>
</html>
