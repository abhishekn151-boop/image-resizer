<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Word (DOCX) to PDF — Free Image Resizer</title>

  <link rel="icon" type="image/png" href="assets/favicon.png" />
  <meta name="description" content="Convert DOCX (Word) documents to PDF client-side using Mammoth + html2pdf." />

  <!-- Global Site CSS -->
  <link rel="stylesheet" href="style.css" />

  <!-- Local Offline Libraries -->
<script src="libs/jszip.min.js"></script>
<script src="libs/mammoth.browser.min.js"></script>
<script src="libs/html2pdf.bundle.min.js"></script>

  <style>
    /* Layout & equal-height */
    .convert-container {
      max-width: 1150px;
      margin: 30px auto;
      padding: 15px;
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 25px;
      align-items: stretch;
    }
    @media (max-width:900px){
      .convert-container { grid-template-columns: 1fr; }
    }

    .convert-left {
      background:#131d32;
      padding:20px;
      border-radius:10px;
      border:1px solid #1d2944;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .drop-area {
      background:#0f1829;
      border:1px dashed #1e2c47;
      padding:18px;
      border-radius:10px;
      color:#cfe9ff;
      text-align:center;
      cursor:pointer;
    }
    .drop-area.active {
      border-color:#4aa8ff;
      box-shadow:0 0 18px rgba(31,155,255,0.08);
    }

    .small-input {
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid #2b3b5a;
      background:#0f1829;
      color:#e8ecf4;
      margin-top:12px;
    }

    .generate-btn {
      width:100%;
      padding:12px;
      background:#1f9bff;
      color:white;
      border:none;
      border-radius:8px;
      cursor:pointer;
      margin-top:12px;
      font-size:16px;
    }

    .muted { color:#9fb1d6; font-size:13px; }
    .note-small { font-size:13px; color:#9fb1d6; }

    /* Preview panel */
    .preview-box {
      background:#0f1829;
      border:1px solid #1d2944;
      padding:18px;
      border-radius:10px;
      min-height:360px;
      color:#dceeff;
      height: 100%;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .preview-toolbar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    /* DOC preview area: white background (PDF pages will be white) */
    .doc-preview {
      background: white;
      color: #111;
      padding:24px;
      border-radius:6px;
      border:1px solid #d8dce6;
      overflow:auto;
      height: calc(100% - 64px); /* leave room for toolbar */
      box-sizing: border-box;
      font-family: "Times New Roman", Georgia, serif;
      line-height: 1.45;
      font-size: 14px;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Strong override for Mammoth generated content so text never appears faint */
    .doc-preview, .doc-preview * {
      color: #111 !important;
    }
    /* Remove transparent backgrounds from nested elements */
    .doc-preview *[style] {
      /* sanitize extremely light inline color values by removing them — JS will try to normalize more smartly */
      background: transparent !important;
    }

    /* Make mammoth generated HTML look reasonable */
    .doc-preview h1, .doc-preview h2, .doc-preview h3 {
      color:#0b2b4a !important;
      margin: 12px 0 !important;
    }
    .doc-preview p { line-height:1.5; margin:8px 0 !important; color:#111 !important; }
    .doc-preview img { max-width:100%; height:auto; display:block; margin:8px 0; }
    .doc-preview table { width:100%; border-collapse:collapse; margin:8px 0; }
    .doc-preview table td, .doc-preview table th { border:1px solid #ccc; padding:6px; }

    .status {
      font-size:13px;
      color:#cfe9ff;
    }

    .hidden { display:none; }
  </style>
</head>

<body>

<!-- NAVBAR -->
<div id="navbar"></div>
<script>
fetch("components/navbar.html")
  .then(r => r.text())
  .then(html => {
    document.getElementById("navbar").innerHTML = html;
    const ham = document.getElementById("hamburger");
    const menu = document.getElementById("mobileMenu");
    if (ham && menu) ham.onclick = () => menu.classList.toggle("active");
  });
</script>

<header class="head" style="max-width:1150px;margin:18px auto 0;padding:0 15px;">
  <h1>Word → PDF Converter</h1>
  <p class="tagline">Advanced client-side DOCX → PDF using Mammoth + html2pdf. Improved color normalization for readable PDFs.</p>
</header>

<div class="convert-container">

  <!-- LEFT: settings/upload -->
  <div class="convert-left">
    <div>
      <h3 style="color:#7fc6ff;">Upload DOCX</h3>
      <div id="drop-area" class="drop-area">
        <h4 id="drop-title">Drop .docx here</h4>
        <p class="note-small">or click to browse — single document only</p>
        <input id="fileInput" type="file" accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document" hidden>
      </div>

      <div style="margin-top:14px;">
        <div class="muted">Output filename</div>
        <input id="outName" class="small-input" placeholder="document.pdf" value="document.pdf">
      </div>

      <div style="margin-top:12px;">
        <div class="muted">PDF Options</div>
        <select id="pdfFormat" class="small-input" title="PDF page format">
          <option value="a4">A4 (portrait)</option>
          <option value="letter">Letter (portrait)</option>
          <option value="auto" selected>Auto (match content width)</option>
        </select>
      </div>

      <div style="margin-top:12px;">
        <label class="muted">Quality / DPI (affects image rendering)</label>
        <input id="pdfScale" class="small-input" type="number" min="0.5" max="2" step="0.1" value="1">
        <div class="note-small">1 = default scale. Increase for higher resolution (larger PDF).</div>
      </div>
    </div>

    <div style="margin-top:auto;">
      <button id="convertBtn" class="generate-btn" disabled>Convert to PDF</button>
      <button id="resetBtn" class="generate-btn" style="background:#6c757d;margin-top:8px;">Reset</button>
      <div style="margin-top:10px;" class="status" id="statusText">No document loaded.</div>
    </div>
  </div>

  <!-- RIGHT: preview -->
  <div class="preview-box">
    <div class="preview-toolbar">
      <div class="note-small">Preview (rendered HTML from DOCX)</div>
      <div>
        <button id="downloadHtmlBtn" class="generate-btn" style="padding:8px 12px; font-size:14px; background:#2dbb6b; margin-right:8px;" disabled>Download PDF</button>
        <button id="openPreviewBtn" class="generate-btn" style="padding:8px 12px; font-size:14px;" disabled>Open Preview</button>
      </div>
    </div>

    <div id="docPreview" class="doc-preview">
      <div id="noPreview" class="muted">No document loaded. Upload a DOCX to see a preview.</div>
      <!-- Mammoth will inject HTML here -->
    </div>
  </div>

</div>

<!-- FOOTER -->
<footer class="vertical-footer">
  <ul>
    <li><a href="about.html">About Us</a></li>
    <li><a href="privacy.html">Privacy Policy</a></li>
    <li><a href="terms.html">Terms of Service</a></li>
    <li><a href="contact.html">Contact</a></li>
    <li><a href="faq.html">FAQ</a></li>
  </ul>
  <p>© <span id="year"></span> Free Image Resizer — All Rights Reserved.</p>
</footer>
<script>document.getElementById("year").textContent = new Date().getFullYear();</script>

<script>
/* ----------------------------
   Basic elements
----------------------------- */
const dropArea = document.getElementById("drop-area");
const fileInput = document.getElementById("fileInput");
const docPreview = document.getElementById("docPreview");
const noPreview = document.getElementById("noPreview");
const convertBtn = document.getElementById("convertBtn");
const resetBtn = document.getElementById("resetBtn");
const statusText = document.getElementById("statusText");
const outName = document.getElementById("outName");
const pdfFormat = document.getElementById("pdfFormat");
const pdfScale = document.getElementById("pdfScale");
const downloadHtmlBtn = document.getElementById("downloadHtmlBtn");
const openPreviewBtn = document.getElementById("openPreviewBtn");

let currentFile = null;
let currentDocHtml = "";
let currentBlobUrl = null;

/* ----------------------------
   Drag & drop + file select (FIXED)
----------------------------- */

// Click (more reliable than addEventListener)
dropArea.onclick = function () {
  fileInput.dispatchEvent(
    new MouseEvent("click", { bubbles: true })
  );
};

// Browse
fileInput.addEventListener("change", () => {
  if (fileInput.files.length > 0) handleFile(fileInput.files[0]);
  fileInput.value = ""; // reset
});

// Drag over
dropArea.addEventListener("dragover", (e) => {
  e.preventDefault();
  e.stopPropagation();
  dropArea.classList.add("active");
});

// Drag leave
dropArea.addEventListener("dragleave", () => {
  dropArea.classList.remove("active");
});

// Drop (CRITICAL FIX)
dropArea.addEventListener("drop", (e) => {
  e.preventDefault();
  e.stopPropagation();
  dropArea.classList.remove("active");
  if (e.dataTransfer.files.length > 0) {
    handleFile(e.dataTransfer.files[0]);
  }
});

/* ----------------------------
   Handle DOCX file using Mammoth
----------------------------- */
async function handleFile(file) {
  if (!file) return;
  const name = file.name || "document.docx";
  if (!/\.docx$/i.test(name)) {
    alert("Please upload a .docx file.");
    return;
  }

  resetState();
  currentFile = file;
  statusText.textContent = "Loading and parsing DOCX... (this may take a few seconds)";
  convertBtn.disabled = true;
  downloadHtmlBtn.disabled = true;
  openPreviewBtn.disabled = true;

  try {
    const arrayBuffer = await file.arrayBuffer();

    // Mammoth options: convert images to data URIs so they appear in preview and PDF
    const options = {
      convertImage: mammoth.images.inline(function(element) {
        return element.read("base64").then(function(imageBuffer) {
          return { src: "data:" + element.contentType + ";base64," + imageBuffer };
        });
      })
    };

    const result = await mammoth.convertToHtml({arrayBuffer: arrayBuffer}, options);
    const html = result.value; // generated HTML string
    currentDocHtml = html;

    // Inject into preview area — wrap with a container for styling
    docPreview.innerHTML = "<div id='mammothInner' class='mammoth-inner'>" + html + "</div>";
    // remove placeholder if present
    const placeholder = document.getElementById("noPreview");
    if (placeholder) placeholder.remove();

    // Post-process the generated HTML to normalize colors and inline styles that are too light
    normalizeGeneratedHtml(document.getElementById("mammothInner"));

    // Post-process images: ensure they are not too wide (keep responsive)
    docPreview.querySelectorAll("img").forEach(img => {
      img.style.maxWidth = "100%";
      img.style.height = "auto";
      img.loading = "lazy";
    });

    statusText.textContent = "Document parsed. Preview ready.";
    convertBtn.disabled = false;
    downloadHtmlBtn.disabled = false;
    openPreviewBtn.disabled = false;

  } catch (err) {
    console.error(err);
    alert("Failed to parse DOCX. The file may be complex or corrupted.");
    statusText.textContent = "Failed to parse document.";
  }
}

/* ----------------------------
   Normalize generated HTML colors
   - Force dark color for all text nodes
   - Remove extremely light color inline styles coming from Word's themes
----------------------------- */
function normalizeGeneratedHtml(container) {
  if (!container) return;

  // Walk all elements and fix inline color styles that are very light or look like theme tokens
  const els = container.querySelectorAll("*");
  for (const el of els) {
    // Remove any background color inline styles (prevent transparency issues)
    if (el.style && el.style.backgroundColor) {
      el.style.backgroundColor = "transparent";
    }

    // If color is set inline, parse it and decide whether to override
    const inlineColor = el.style && (el.style.color || el.style.fill);
    if (inlineColor) {
      const rgb = parseColor(inlineColor);
      if (rgb) {
        const luminance = (0.2126*rgb.r + 0.7152*rgb.g + 0.0722*rgb.b)/255;
        // If luminance is very high (very light color), override to dark
        if (luminance > 0.85) {
          el.style.color = "#111";
        }
      } else {
        // if unknown format, just clear and set dark
        el.style.color = "#111";
      }
    }
    // Enforce readable font color if nothing set
    el.style.color = el.style.color || "#111";
    // Ensure font variants are legible
    el.style.lineHeight = el.style.lineHeight || "1.45";
    el.style.fontFamily = el.style.fontFamily || '"Times New Roman", Georgia, serif';
  }

  // Fine-grain: ensure top-level block text is dark
  container.style.color = "#111";
  container.style.background = "transparent";
}

/* Parse CSS color strings (simple) */
function parseColor(colorStr) {
  if (!colorStr) return null;
  colorStr = colorStr.trim().toLowerCase();

  // rgb or rgba
  const m = colorStr.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
  if (m) return { r: parseInt(m[1]), g: parseInt(m[2]), b: parseInt(m[3]) };

  // hex #rrggbb or #rgb
  const mh = colorStr.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
  if (mh) {
    let hex = mh[1];
    if (hex.length === 3) {
      hex = hex.split("").map(ch => ch+ch).join("");
    }
    return { r: parseInt(hex.substr(0,2),16), g: parseInt(hex.substr(2,2),16), b: parseInt(hex.substr(4,2),16) };
  }

  return null;
}

/* ----------------------------
   Convert preview HTML -> PDF (html2pdf)
----------------------------- */
convertBtn.addEventListener("click", async () => {
  if (!currentDocHtml) return alert("No document to convert.");

  convertBtn.disabled = true;
  convertBtn.textContent = "Converting to PDF...";

  // element to render
  const element = document.getElementById("mammothInner") || docPreview;

  // Ensure images have crossorigin attribute (useCORS)
  element.querySelectorAll("img").forEach(img => {
    try { img.setAttribute("crossorigin","anonymous"); } catch(e){}
  });

  const filename = (outName.value && outName.value.trim()) ? outName.value.trim() : "document.pdf";
  const scale = Number(pdfScale.value) || 1;

  // html2pdf options
  const opt = {
    margin:       10, // mm
    filename:     filename,
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: scale, useCORS: true, allowTaint: false, logging: false },
    jsPDF:        { unit: 'mm', format: (pdfFormat.value === 'auto' ? 'a4' : pdfFormat.value), orientation: 'portrait' },
    pagebreak:    { mode: ['css', 'legacy'] }
  };

  // If auto: keep 'a4' but render content width — html2pdf will paginate
  if (pdfFormat.value === 'auto') {
    opt.jsPDF.format = 'a4';
  }

  try {
    statusText.textContent = "Rendering PDF — this may take a few seconds...";
    await html2pdf().set(opt).from(element).save();
    statusText.textContent = "PDF ready and downloaded.";
  } catch (err) {
    console.error(err);
    alert("PDF generation failed. See console for details.");
    statusText.textContent = "PDF generation failed.";
  } finally {
    convertBtn.disabled = false;
    convertBtn.textContent = "Convert to PDF";
  }
});

/* Download toolbar button triggers same */
downloadHtmlBtn.addEventListener("click", () => convertBtn.click());

/* Open preview in new tab (clean HTML wrapper) */
openPreviewBtn.addEventListener("click", () => {
  const previewHtml = currentDocHtml || "<p>No preview</p>";
  const win = window.open("", "_blank");
  if (!win) return alert("Pop-up blocked. Allow pop-ups to open preview.");
  win.document.write("<!doctype html><html><head><meta charset='utf-8'><title>Preview</title></head><body>" + previewHtml + "</body></html>");
  win.document.close();
});

/* Reset / cleanup */
resetBtn.addEventListener("click", () => {
  if (!confirm("Reset and remove loaded document?")) return;
  resetState();
});

function resetState() {
  currentFile = null;
  currentDocHtml = "";
  if (currentBlobUrl) { URL.revokeObjectURL(currentBlobUrl); currentBlobUrl = null; }
  docPreview.innerHTML = "<div id='noPreview' class='muted'>No document loaded. Upload a DOCX to see a preview.</div>";
  statusText.textContent = "No document loaded.";
  convertBtn.disabled = true;
  downloadHtmlBtn.disabled = true;
  openPreviewBtn.disabled = true;
  outName.value = "document.pdf";
}

/* small util for human-readable file size (optional) */
function readable(bytes) {
  if (bytes < 1024) return bytes + " B";
  let units = ["KB","MB","GB"];
  let i = Math.floor(Math.log(bytes) / Math.log(1024));
  return (bytes / Math.pow(1024, i)).toFixed(1) + " " + units[i-1];
}

/* Init */
resetState();
</script>

</body>
</html>
