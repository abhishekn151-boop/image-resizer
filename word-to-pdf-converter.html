<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Word → PDF — Auto A4 Pagination</title>

<link rel="icon" type="image/png" href="assets/favicon.png" />
<meta name="description" content="DOCX → PDF with automatic A4 pagination (no heading detection required)." />

<!-- Local libraries -->
<script src="libs/jszip.min.js"></script>
<script src="libs/mammoth.browser.min.js"></script>
<script src="libs/html2pdf.bundle.min.js"></script>

<style>
  body { background:#071024; color:#e8eef8; font-family: Inter, system-ui, sans-serif; margin:0; padding:24px; }
  .wrap { max-width:1150px; margin:0 auto; }
  h1 { color:#fff; text-align:center; margin:8px 0 6px; }
  .convert-container {
    display:grid;
    grid-template-columns:360px 1fr;
    gap:20px;
    align-items:stretch;
    margin-top:18px;
  }
  @media (max-width:900px){ .convert-container{ grid-template-columns:1fr; } }

  .panel {
    background:#0e1a2a;
    border:1px solid #1f2f44;
    border-radius:10px;
    padding:16px;
    box-sizing:border-box;
    height:100%;
    display:flex;
    flex-direction:column;
  }

  .drop {
    background:#0b1420;
    border:2px dashed #21334a;
    border-radius:8px;
    padding:18px;
    text-align:center;
    cursor:pointer;
    color:#9ec6ff;
  }

  .small-input { width:100%; padding:10px; border-radius:8px; border:1px solid #23364f; background:#081220; color:#dfefff; margin-top:10px; }
  .btn { width:100%; padding:10px; border-radius:8px; border:none; background:#1f9bff; color:white; font-size:15px; cursor:pointer; margin-top:12px; }
  .btn.secondary { background:#55616f; }
  .muted { color:#9fb1d6; font-size:14px; margin-top:10px; }

  .preview-panel {
    background:#071424;
    border:1px solid #1b2b3f;
    border-radius:10px;
    padding:16px;
    min-height:360px;
    box-sizing:border-box;
  }

  .doc-preview {
    background:white;
    color:#111;
    padding:20px;
    border-radius:6px;
    border:1px solid #d8dce6;
    box-sizing:border-box;
    font-family:"Times New Roman", Georgia, serif;
    line-height:1.45;
    max-width:100%;
    overflow:auto;
  }

  /* Offscreen containers: keep them renderable (not display:none). */
  .offscreen {
    position: absolute;
    top: 0;
    left: 0;
    visibility: visible; /* must be renderable for measurement */
    opacity: 1;
    pointer-events: none;
    width: 0;
    height: 0;
    overflow: hidden;
  }

  .pdf-page {
    width:210mm;
    height:297mm;
    background:white;
    overflow:hidden;
    margin-bottom:8px;
    box-sizing:border-box;
  }

  .doc-preview-responsive { max-width:100%; }

  /* Remove absolute positioning from mammoth output in preview so layout becomes flow */
  #previewWrapper *[style*="position:absolute"] {
    position: static !important;
    left: auto !important;
    top: auto !important;
    transform: none !important;
  }
</style>
</head>
<body>
  <div id="renderArea" style="position:relative; width:100%; min-height:10px;"></div>

<!-- NAVBAR -->
<div id="navbar"></div>
<script>
fetch("components/navbar.html")
  .then(r => r.text())
  .then(html => {
    document.getElementById("navbar").innerHTML = html;
    const ham = document.getElementById("hamburger");
    const menu = document.getElementById("mobileMenu");
    if (ham && menu) ham.onclick = () => menu.classList.toggle("active");
  }).catch(e => { console.warn('navbar load failed', e); });
</script>

<!-- OPEN WRAPPER -->
<div class="wrap">

  <h1>Word → PDF Converter (Auto A4 Pagination)</h1>

  <div class="convert-container">

    <div class="panel">
      <h3 style="color:#7fc6ff;margin:0 0 10px;">Upload DOCX</h3>

      <div id="dropArea" class="drop" role="button">
        <div style="font-weight:600;">Drop .docx here</div>
        <div class="muted">or click to browse</div>
        <input id="fileInput" type="file" accept=".docx" hidden>
      </div>

      <label class="muted">Output filename</label>
      <input id="outName" class="small-input" value="document.pdf">

      <label class="muted">PDF quality (scale)</label>
      <input id="pdfScale" class="small-input" type="number" value="1" min="0.5" max="2" step="0.1">

      <button id="convertBtn" class="btn" disabled>Convert to PDF</button>
      <button id="resetBtn" class="btn secondary">Reset</button>

      <div id="status" class="muted">No document loaded.</div>
    </div>

    <div class="preview-panel panel">
      <div id="previewWrapper" class="doc-preview doc-preview-responsive">
        <div id="noPreview" class="muted">No document loaded. Preview appears here.</div>
        <!-- Mammoth HTML will be injected here for preview -->
      </div>
    </div>

  </div> <!-- end convert-container -->

</div> <!-- end wrap -->

<!-- Offscreen containers used by paginator & pages (must be in the DOM and renderable) -->
<div id="paginatorOffscreen" class="offscreen" aria-hidden="true"></div>
<div id="pdfPagesContainer" class="offscreen" aria-hidden="true"></div>
<script>
/* ---------- Utilities ---------- */
const mmToPx = (mm) => (mm / 25.4) * 96; // CSS px at 96dpi
const A4 = { w_mm: 210, h_mm: 297 };
const pageCssWidthPx = Math.round(mmToPx(A4.w_mm));
const pageCssHeightPx = Math.round(mmToPx(A4.h_mm));

/* ---------- Elements ---------- */
const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');
const previewWrapper = document.getElementById('previewWrapper');
const noPreview = document.getElementById('noPreview');
const convertBtn = document.getElementById('convertBtn');
const resetBtn = document.getElementById('resetBtn');
const outName = document.getElementById('outName');
const pdfScaleEl = document.getElementById('pdfScale');
const status = document.getElementById('status');

const paginatorOffscreen = document.getElementById('paginatorOffscreen');
const pdfPagesContainer = document.getElementById('pdfPagesContainer');

let currentDocHtml = "";
let currentFileName = "";

/* ---------- Drag & drop & file select ---------- */
dropArea.onclick = () => fileInput.click();

dropArea.addEventListener("dragover", (e) => {
  e.preventDefault();
  dropArea.classList.add('active');
});
dropArea.addEventListener("dragleave", () => dropArea.classList.remove('active'));
dropArea.addEventListener("drop", (e) => {
  e.preventDefault();
  dropArea.classList.remove('active');
  if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
});

fileInput.addEventListener('change', () => {
  if (fileInput.files && fileInput.files[0]) handleFile(fileInput.files[0]);
  fileInput.value = '';
});

/* ---------- Handle DOCX -> HTML via Mammoth ---------- */
async function handleFile(file) {
  if (!file) return;
  currentFileName = file.name || 'document.docx';
  if (!/\.docx$/i.test(currentFileName)) {
    alert('Please upload a .docx file.');
    return;
  }

  status.textContent = 'Parsing DOCX...';
  convertBtn.disabled = true;
  previewWrapper.innerHTML = '';

  try {
    const ab = await file.arrayBuffer();

    // Convert images inline so preview + pages contain data-URIs
    const options = {
      convertImage: mammoth.images.inline(function(element) {
        return element.read("base64").then(function(imageBuffer) {
          return { src: "data:" + element.contentType + ";base64," + imageBuffer };
        });
      })
    };

    const result = await mammoth.convertToHtml({ arrayBuffer: ab }, options);
    currentDocHtml = result.value || '';
    previewWrapper.innerHTML = currentDocHtml;
    noPreview && (noPreview.style.display = 'none');

    // sanitize: remove absolute positions inside preview so preview renders in normal flow
    const absoluteEls = previewWrapper.querySelectorAll('*[style*="position:absolute"]');
    absoluteEls.forEach(el => {
      el.style.position = 'static';
      el.style.left = 'auto';
      el.style.top = 'auto';
      el.style.transform = 'none';
    });

    // ensure images are responsive
    previewWrapper.querySelectorAll('img').forEach(img => {
      img.style.maxWidth = '100%';
      img.style.height = 'auto';
      img.loading = 'lazy';
      try { img.setAttribute('crossorigin','anonymous'); } catch(e){}
    });

    status.textContent = 'Document loaded.';
    convertBtn.disabled = false;
  } catch (err) {
    console.error('Mammoth error', err);
    alert('Failed to parse DOCX. See console.');
    status.textContent = 'Load failed.';
  }
}

/* ---------- helper: wait for imgs inside an element ---------- */
function waitForImages(root, timeout = 5000) {
  const imgs = Array.from(root.querySelectorAll('img'));
  if (!imgs.length) return Promise.resolve();
  let loaded = 0;
  return new Promise((resolve) => {
    const done = () => {
      loaded++;
      if (loaded >= imgs.length) {
        clearTimeout(timer);
        resolve();
      }
    };
    let timer = setTimeout(() => { resolve(); }, timeout);
    imgs.forEach(img => {
      if (img.complete && img.naturalWidth !== 0) done();
      else {
        img.addEventListener('load', done, { once: true });
        img.addEventListener('error', done, { once: true });
      }
    });
  });
}

/* ---------- Pagination builder (robust) ----------
   - Render HTML inside paginatorOffscreen (render area) so browser computes accurate heights.
   - Wait for images to load so measurements are correct.
   - Create .pdf-page elements containing clones shifted by translateY.
*/
async function buildPagedDocument(html, scale = 1) {
  // clear previous
  paginatorOffscreen.innerHTML = '';
  pdfPagesContainer.innerHTML = '';

  const render = document.createElement('div');
  render.style.width = pageCssWidthPx + 'px';
  render.style.boxSizing = 'border-box';
  render.style.padding = '20px';
  render.style.fontFamily = '"Times New Roman", Georgia, serif';
  render.style.lineHeight = '1.45';
  render.innerHTML = html;

  // append render into offscreen container (it must be in DOM and renderable)
  paginatorOffscreen.appendChild(render);

  // make images responsive inside the render
  render.querySelectorAll('img').forEach(img => {
    img.style.maxWidth = '100%';
    img.style.height = 'auto';
    try { img.setAttribute('crossorigin','anonymous'); } catch(e){}
  });

  // wait for images, then allow layout to settle
  await waitForImages(render, 4000);
  await new Promise(r => requestAnimationFrame(r));

  const totalHeight = render.scrollHeight;
  const pageHeight = pageCssHeightPx;
  const pages = Math.max(1, Math.ceil(totalHeight / pageHeight));

  for (let i = 0; i < pages; i++) {
    const pageWrap = document.createElement('div');
    pageWrap.className = 'pdf-page';
    pageWrap.style.width = pageCssWidthPx + 'px';
    pageWrap.style.height = pageCssHeightPx + 'px';
    pageWrap.style.boxSizing = 'border-box';
    pageWrap.style.position = 'relative';
    pageWrap.style.overflow = 'hidden';
    pageWrap.style.background = 'white';

    const clone = render.cloneNode(true);

    // absolutely position the clone inside this page and shift it up to show slice
    clone.style.position = 'absolute';
    clone.style.left = '0';
    clone.style.top = '0';
    clone.style.width = pageCssWidthPx + 'px';
    clone.style.boxSizing = 'border-box';
    clone.style.transform = `translateY(-${i * pageHeight}px)`;
    clone.style.webkitTransform = clone.style.transform;

    pageWrap.appendChild(clone);
// IMPORTANT: pages must be appended directly to a NEW NORMAL BLOCK CONTAINER (not offscreen)
  }

  // return pages count and container (pdfPagesContainer holds .pdf-page children now)
  return { pages, container: pdfPagesContainer };
}
</script>
<script>
/* ---------- Convert to PDF (robust wrapper append) ---------- */
convertBtn.addEventListener('click', async () => {
  if (!currentDocHtml) { alert('No document loaded.'); return; }

  convertBtn.disabled = true;
  status.textContent = 'Preparing pages...';

  try {
    const scale = Number(pdfScaleEl.value) || 1;

    const { pages, container } = await buildPagedDocument(currentDocHtml, scale);

    status.textContent = `Rendering ${pages} page(s)...`;

    // Prepare visible render area
    const renderArea = document.getElementById("renderArea");
    renderArea.innerHTML = ""; // clear old pages

    // Move pages into renderArea (IMPORTANT!!)
    Array.from(container.children).forEach(page => {
      page.style.position = "relative";  // ensure visible
      page.style.left = "0";
      page.style.top = "0";
      renderArea.appendChild(page);
    });

    // Ensure DOM rendered
    await new Promise(r => requestAnimationFrame(r));

    const opt = {
      margin: 0,
      filename: outName.value.trim() || 'document.pdf',
      html2canvas: { scale, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
    };

    await html2pdf().set(opt).from(renderArea).save();

    status.textContent = 'PDF created and downloaded.';

    // cleanup
    renderArea.innerHTML = "";

  } catch (err) {
    console.error('PDF generation error:', err);
    alert('PDF generation failed — check console.');
    status.textContent = 'PDF failed.';
  } finally {
    convertBtn.disabled = false;
  }
});

/* reset */
resetBtn.addEventListener('click', () => {
  currentDocHtml = '';
  previewWrapper.innerHTML = '<div id="noPreview" class="muted">No document loaded. Preview appears here.</div>';
  noPreview && (noPreview.style.display = '');
  convertBtn.disabled = true;
  status.textContent = 'No document loaded.';
  pdfPagesContainer.innerHTML = '';
  paginatorOffscreen.innerHTML = '';
});

/* initial */
status.textContent = 'No document loaded.';
</script>
</body>
</html>
